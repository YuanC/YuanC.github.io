'use strict';var desktop,svg,simulation,width,height,forces={collide:null,center:null,manyBody:null,x:null,y:null},data={nodes:[],colours:[],sizes:[]},svgs={circles:null,borders:null,imgPatterns:null,imgs:null},config={HOVER_RAD_CHANGE:10,SPAWN_RANGE:2e3,NODE_MARGIN:2,LABEL_Y_OFFSET:-10,IMG_BORDER:1,IMG_BORDER_FOCUS:3,RAD_GROWTH_RATE:1,MOBILE_MAX_WIDTH:766},hovernode,tooltip,redraw=function(){d3.selectAll('svg > *').remove(),simulation=d3.forceSimulation(),width=desktop.clientWidth,height=desktop.clientHeight,console.log('Redrawing: '+width+' x '+height),svg.attr('width',width).attr('height',height),resetForces(),simulation.nodes(data.nodes).force('manyBody',forces.manyBody).force('center',forces.center).force('x',forces.x).force('y',forces.y).force('collide',forces.collide).velocityDecay(0.6).on('tick',ticked),svg.append('svg:defs').selectAll('img-patterns').data(data.nodes).enter().append('pattern').attr('class','img-patterns').attr('id',function(c){return c.name.split(' ').join('-')}).attr('patternContentUnits','objectBoundingBox').append('image').attr('xlink:href',function(c){return c.img});var b=svg.selectAll('.node').data(data.nodes).enter().append('g').attr('class','node');b.append('circle').attr('class','border-circle').style('fill',function(c){return data.colours[c.category]}),b.append('circle').attr('class','img-circle').style('fill',function(c){return'url(#'+c.name.split(' ').join('-')+')'}),svgs.borders=b.selectAll('.border-circle'),svgs.imgs=svg.selectAll('image'),svgs.imgPatterns=svg.selectAll('.img-patterns'),svgs.circles=b.selectAll('.img-circle'),b.on('mouseenter',function(c){c.r=c.rDefault+config.HOVER_RAD_CHANGE,hovernode=c,svg.style('background-color',data.colours[c.category]),refreshSimulationNodes()}).on('mouseleave',function(c){c.r=c.rDefault,hovernode=null,svg.style('background-color','#fff'),refreshSimulationNodes()}).on('click',function(c){modal.openModal(c)})},ticked=function(){svgs.borders.attr('r',function(b){return b.r}).attr('cx',function(b){return b.x}).attr('cy',function(b){return b.y}),svgs.circles.attr('r',function(b){return b.r-(b===hovernode?config.IMG_BORDER_FOCUS:config.IMG_BORDER)}).attr('cx',function(b){return b.x}).attr('cy',function(b){return b.y}),svgs.imgs.attr('width','1').attr('height','1').attr('preserveAspectRatio','xMidYMid slice'),svgs.imgPatterns.attr('viewbox','0 0 1 1').attr('preserveAspectRatio','xMidYMid slice').attr('width',function(){return'100%'}).attr('height',function(){return'100%'})},resetForces=function(){forces.collide=d3.forceCollide().radius(function(b){return b.r+config.NODE_MARGIN}).iterations(40).strength(0.9),forces.center=d3.forceCenter([width/2,height/2]).x(width/2).y(height/2),forces.manyBody=d3.forceManyBody().strength(1e3),forces.x=d3.forceX(width/2).strength(0.1),forces.y=d3.forceY(height/2).strength(0.1)},refreshSimulationNodes=function(){simulation.stop(),simulation.nodes(data.nodes),simulation.alpha(1),simulation.restart()};d3.json('dist/data/nodedata.json',function(a,b){if(a)throw a;data.nodes=b.nodes,data.colours=b.colours,data.sizes=b.sizes,desktop=document.getElementById('desktop'),svg=d3.select(desktop).append('svg'),width=desktop.clientWidth,height=desktop.clientHeight,data.nodes.map(function(c){return c.r=data.sizes[c.category],c.rDefault=data.sizes[c.category],c.x=Math.random()*config.SPAWN_RANGE-config.SPAWN_RANGE/2+width/2,c.y=Math.random()*config.SPAWN_RANGE-config.SPAWN_RANGE/2+height/2,c}),redraw(),window.addEventListener('resize',function(){desktop.clientWidth>config.MOBILE_MAX_WIDTH?redraw():simulation.stop()})});